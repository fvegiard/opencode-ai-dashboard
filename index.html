<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>fvegiard · AI System Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.30.2/cytoscape.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dagre@0.8.5/dist/dagre.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0d1117;
    --sidebar: #161b22;
    --border: #30363d;
    --accent: #58a6ff;
    --green: #3fb950;
    --purple: #bc8cff;
    --orange: #ffa657;
    --teal: #56d364;
    --yellow: #e3b341;
    --red: #f85149;
    --pink: #f778ba;
    --cyan: #39c5cf;
    --gold: #d29922;
    --text: #e6edf3;
    --text2: #8b949e;
  }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Text', sans-serif;
    font-size: 13px;
    overflow: hidden;
  }

  /* ─── TOP BAR ─────────────────────────────────── */
  #topbar {
    height: 44px;
    background: var(--sidebar);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 16px;
    gap: 12px;
    position: relative;
    z-index: 10;
    flex-shrink: 0;
  }

  #topbar .logo {
    font-weight: 700;
    font-size: 14px;
    color: var(--text);
    letter-spacing: -0.02em;
    white-space: nowrap;
  }

  #topbar .logo span { color: var(--accent); }

  #topbar .sep {
    width: 1px;
    height: 20px;
    background: var(--border);
    flex-shrink: 0;
  }

  #topbar .live-badge {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    color: var(--green);
    font-weight: 600;
    white-space: nowrap;
  }

  .live-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: var(--green);
    animation: pulse 2s infinite;
    flex-shrink: 0;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(63,185,80,0.4); }
    50% { opacity: 0.7; box-shadow: 0 0 0 4px rgba(63,185,80,0); }
  }

  #topbar .db-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #1c2128;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 3px 10px;
    font-size: 11px;
    color: var(--text2);
    white-space: nowrap;
  }

  #topbar .db-badge .db-icon { color: var(--green); font-size: 13px; }
  #topbar .db-badge strong { color: var(--text); }

  #topbar .right {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  #topbar .tag {
    background: #1c2128;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2px 8px;
    font-size: 10px;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    white-space: nowrap;
  }

  #topbar .kbd-hint {
    font-size: 10px;
    color: var(--text2);
    white-space: nowrap;
  }

  /* ─── MAIN LAYOUT ─────────────────────────────── */
  #app {
    display: flex;
    height: calc(100vh - 44px);
    overflow: hidden;
  }

  /* ─── LEFT SIDEBAR ────────────────────────────── */
  #sidebar {
    width: 220px;
    flex-shrink: 0;
    background: var(--sidebar);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-header {
    padding: 10px 14px 8px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text2);
    font-weight: 600;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .diagram-list {
    flex: 1;
    overflow-y: auto;
    padding: 6px;
  }

  .diagram-list::-webkit-scrollbar { width: 3px; }
  .diagram-list::-webkit-scrollbar-track { background: transparent; }
  .diagram-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .diagram-card {
    border-radius: 8px;
    padding: 10px 12px;
    margin-bottom: 3px;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.15s ease;
  }

  .diagram-card:hover {
    background: #1c2128;
    border-color: var(--border);
  }

  .diagram-card.active {
    background: #1c2128;
    border-color: var(--accent);
    box-shadow: inset 0 0 0 1px rgba(88,166,255,0.1);
  }

  .card-top {
    display: flex;
    align-items: flex-start;
    gap: 9px;
    margin-bottom: 5px;
  }

  .card-icon {
    width: 30px;
    height: 30px;
    border-radius: 7px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    flex-shrink: 0;
  }

  .card-info { flex: 1; min-width: 0; }

  .card-title {
    font-weight: 600;
    font-size: 12px;
    color: var(--text);
    line-height: 1.3;
  }

  .diagram-card.active .card-title { color: var(--accent); }

  .card-desc {
    font-size: 10px;
    color: var(--text2);
    line-height: 1.4;
    margin-top: 1px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .card-badge {
    display: inline-block;
    background: #21262d;
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 1px 5px;
    font-size: 9px;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 4px;
  }

  .diagram-card.active .card-badge {
    background: rgba(88,166,255,0.08);
    border-color: rgba(88,166,255,0.25);
    color: var(--accent);
  }

  .card-num {
    font-size: 9px;
    color: var(--border);
    flex-shrink: 0;
    margin-top: 2px;
    font-variant-numeric: tabular-nums;
  }

  .diagram-card.active .card-num { color: rgba(88,166,255,0.4); }

  .sidebar-footer {
    padding: 8px 14px;
    border-top: 1px solid var(--border);
    font-size: 10px;
    color: var(--text2);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* icon colors */
  .icon-purple { background: rgba(188,140,255,0.12); }
  .icon-blue   { background: rgba(88,166,255,0.12); }
  .icon-green  { background: rgba(63,185,80,0.12); }
  .icon-orange { background: rgba(255,166,87,0.12); }
  .icon-teal   { background: rgba(86,211,100,0.12); }

  /* ─── CENTER ──────────────────────────────────── */
  #center {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
    background: var(--bg);
    min-width: 0;
  }

  #graph-header {
    padding: 9px 14px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
    background: var(--sidebar);
    min-width: 0;
  }

  #graph-title {
    font-weight: 600;
    font-size: 13px;
    color: var(--text);
    white-space: nowrap;
  }

  #graph-subtitle {
    font-size: 11px;
    color: var(--text2);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  #node-count-badge {
    margin-left: auto;
    flex-shrink: 0;
    background: #21262d;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2px 8px;
    font-size: 10px;
    color: var(--text2);
    white-space: nowrap;
  }

  #cy-wrap {
    flex: 1;
    position: relative;
    overflow: hidden;
  }

  #cy {
    width: 100%;
    height: 100%;
    background: var(--bg);
    background-image:
      radial-gradient(ellipse at 15% 15%, rgba(88,166,255,0.04) 0%, transparent 60%),
      radial-gradient(ellipse at 85% 85%, rgba(188,140,255,0.04) 0%, transparent 60%);
  }

  /* Dot grid */
  #cy-grid {
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 0;
    background-image: radial-gradient(circle, #30363d 1px, transparent 1px);
    background-size: 28px 28px;
    opacity: 0.35;
  }

  /* Legend */
  #legend {
    position: absolute;
    bottom: 10px;
    left: 10px;
    background: rgba(22,27,34,0.92);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 7px 10px;
    z-index: 5;
    pointer-events: none;
    backdrop-filter: blur(4px);
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 10px;
    color: var(--text2);
    margin-bottom: 3px;
    white-space: nowrap;
  }

  .legend-item:last-child { margin-bottom: 0; }

  .legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 2px;
    flex-shrink: 0;
  }

  /* Loading */
  #loading {
    position: absolute;
    inset: 0;
    background: rgba(13,17,23,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 20;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
    backdrop-filter: blur(2px);
  }

  #loading.active { opacity: 1; pointer-events: all; }

  .spinner {
    width: 24px;
    height: 24px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* ─── BOTTOM CONTROLS ─────────────────────────── */
  #graph-controls {
    padding: 7px 14px;
    border-top: 1px solid var(--border);
    background: var(--sidebar);
    display: flex;
    align-items: center;
    gap: 5px;
    flex-shrink: 0;
  }

  .ctrl-btn {
    background: #21262d;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text2);
    padding: 4px 9px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.12s;
    display: flex;
    align-items: center;
    gap: 4px;
    min-width: 30px;
    justify-content: center;
    line-height: 1;
  }

  .ctrl-btn:hover {
    background: #30363d;
    border-color: #484f58;
    color: var(--text);
  }

  .ctrl-btn:active { transform: scale(0.93); }

  #zoom-label {
    font-size: 11px;
    color: var(--text2);
    min-width: 40px;
    text-align: center;
    font-variant-numeric: tabular-nums;
  }

  .ctrl-sep {
    width: 1px;
    height: 18px;
    background: var(--border);
    margin: 0 1px;
    flex-shrink: 0;
  }

  #status-area {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  #layout-tag {
    background: rgba(88,166,255,0.1);
    border: 1px solid rgba(88,166,255,0.2);
    border-radius: 3px;
    padding: 1px 6px;
    font-size: 9px;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 0.07em;
  }

  #status-txt {
    font-size: 10px;
    color: var(--text2);
  }

  /* ─── RIGHT INSPECTOR ─────────────────────────── */
  #inspector {
    width: 240px;
    flex-shrink: 0;
    background: var(--sidebar);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .insp-header {
    padding: 10px 14px 8px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text2);
    font-weight: 600;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .insp-body {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
  }

  .insp-body::-webkit-scrollbar { width: 3px; }
  .insp-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .insp-section { margin-bottom: 18px; }

  .insp-section-title {
    font-size: 10px;
    font-weight: 700;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .insp-section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* Toggles */
  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px solid rgba(48,54,61,0.5);
  }

  .toggle-row:last-child { border-bottom: none; }

  .toggle-label {
    font-size: 12px;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 7px;
  }

  .lbl-icon {
    color: var(--text2);
    font-size: 11px;
    width: 14px;
    text-align: center;
  }

  .toggle {
    position: relative;
    width: 32px;
    height: 18px;
    flex-shrink: 0;
  }

  .toggle input { opacity: 0; width: 0; height: 0; position: absolute; }

  .toggle-track {
    position: absolute;
    inset: 0;
    background: #21262d;
    border: 1px solid var(--border);
    border-radius: 9px;
    cursor: pointer;
    transition: all 0.18s;
  }

  .toggle-track::after {
    content: '';
    position: absolute;
    left: 2px;
    top: 2px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--text2);
    transition: all 0.18s;
  }

  .toggle input:checked + .toggle-track {
    background: rgba(88,166,255,0.15);
    border-color: var(--accent);
  }

  .toggle input:checked + .toggle-track::after {
    left: calc(100% - 14px);
    background: var(--accent);
  }

  /* Sliders */
  .slider-row {
    padding: 5px 0;
    border-bottom: 1px solid rgba(48,54,61,0.5);
  }

  .slider-row:last-child { border-bottom: none; }

  .slider-lbl-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
  }

  .slider-lbl { font-size: 12px; color: var(--text); }
  .slider-val { font-size: 11px; color: var(--accent); font-variant-numeric: tabular-nums; }

  input[type="range"] {
    -webkit-appearance: none;
    width: 100%;
    height: 3px;
    border-radius: 2px;
    background: var(--border);
    outline: none;
    cursor: pointer;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 13px;
    height: 13px;
    border-radius: 50%;
    background: var(--accent);
    border: 2px solid var(--bg);
    cursor: pointer;
    box-shadow: 0 0 0 1px rgba(88,166,255,0.4);
  }

  /* Node inspector */
  #node-inspector {
    background: #1c2128;
    border: 1px solid var(--border);
    border-radius: 7px;
    padding: 10px;
    display: none;
    animation: fadeIn 0.15s ease;
  }

  #node-inspector.visible { display: block; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: none; } }

  .ni-header {
    display: flex;
    align-items: center;
    gap: 7px;
    margin-bottom: 9px;
  }

  .ni-dot {
    width: 9px;
    height: 9px;
    border-radius: 2px;
    flex-shrink: 0;
  }

  .ni-name {
    font-weight: 600;
    font-size: 12px;
    color: var(--text);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .ni-row {
    display: flex;
    justify-content: space-between;
    padding: 3px 0;
    font-size: 11px;
    border-bottom: 1px solid rgba(48,54,61,0.4);
  }

  .ni-row:last-child { border-bottom: none; }
  .ni-key { color: var(--text2); }
  .ni-val { color: var(--text); font-weight: 500; }

  /* Stats */
  #graph-stats {
    padding: 8px 10px;
    border-top: 1px solid var(--border);
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 5px;
  }

  .stat-box {
    background: #1c2128;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 8px;
    text-align: center;
  }

  .stat-val {
    font-size: 17px;
    font-weight: 700;
    color: var(--text);
    line-height: 1.1;
    font-variant-numeric: tabular-nums;
  }

  .stat-lbl {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text2);
    margin-top: 1px;
  }

  /* Tooltip */
  #tooltip {
    position: fixed;
    background: #1c2128;
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 11px;
    color: var(--text);
    pointer-events: none;
    z-index: 1000;
    display: none;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    max-width: 180px;
    backdrop-filter: blur(4px);
  }

  #tooltip strong {
    color: var(--accent);
    display: block;
    font-size: 12px;
    margin-bottom: 2px;
  }

  #tooltip span { color: var(--text2); font-size: 10px; }
</style>
</head>
<body>

<!-- TOP BAR -->
<div id="topbar">
  <div class="logo">fvegiard <span>·</span> AI System</div>
  <div class="sep"></div>
  <div class="live-badge">
    <div class="live-dot"></div>
    Live
  </div>
  <div class="sep"></div>
  <div class="db-badge">
    <span class="db-icon">⬡</span>
    Supabase:&nbsp;<strong id="supabase-count">—</strong>&nbsp;rows
  </div>
  <div class="right">
    <span class="kbd-hint">Keys 1–5 to switch</span>
    <div class="tag">Cytoscape 3.30</div>
    <div class="tag">dagre</div>
  </div>
</div>

<!-- APP -->
<div id="app">

  <!-- LEFT SIDEBAR -->
  <div id="sidebar">
    <div class="sidebar-header">
      <svg width="11" height="11" viewBox="0 0 16 16" fill="currentColor"><path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5zm8 0A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5zm-8 8A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5zm8 0A1.5 1.5 0 0 1 10.5 9h3A1.5 1.5 0 0 1 15 10.5v3A1.5 1.5 0 0 1 13.5 15h-3A1.5 1.5 0 0 1 9 13.5z"/></svg>
      Diagrams
    </div>

    <div class="diagram-list">

      <div class="diagram-card active" data-id="system" onclick="loadDiagram('system')">
        <div class="card-top">
          <div class="card-icon icon-purple">◈</div>
          <div class="card-info">
            <div class="card-title">System Architecture</div>
            <div class="card-desc">Full stack overview · all services</div>
          </div>
          <div class="card-num">1</div>
        </div>
        <span class="card-badge">Flowchart</span>
      </div>

      <div class="diagram-card" data-id="agents" onclick="loadDiagram('agents')">
        <div class="card-top">
          <div class="card-icon icon-blue">◈</div>
          <div class="card-info">
            <div class="card-title">Agent Routing</div>
            <div class="card-desc">Multi-agent orchestration</div>
          </div>
          <div class="card-num">2</div>
        </div>
        <span class="card-badge">Network</span>
      </div>

      <div class="diagram-card" data-id="memory" onclick="loadDiagram('memory')">
        <div class="card-top">
          <div class="card-icon icon-green">◈</div>
          <div class="card-info">
            <div class="card-title">Memory Flow</div>
            <div class="card-desc">Context loading &amp; caching</div>
          </div>
          <div class="card-num">3</div>
        </div>
        <span class="card-badge">Sequence</span>
      </div>

      <div class="diagram-card" data-id="mcp" onclick="loadDiagram('mcp')">
        <div class="card-top">
          <div class="card-icon icon-orange">◈</div>
          <div class="card-info">
            <div class="card-title">MCP Inventory</div>
            <div class="card-desc">All MCP servers registered</div>
          </div>
          <div class="card-num">4</div>
        </div>
        <span class="card-badge">Hub-Spoke</span>
      </div>

      <div class="diagram-card" data-id="netlify" onclick="loadDiagram('netlify')">
        <div class="card-top">
          <div class="card-icon icon-teal">◈</div>
          <div class="card-info">
            <div class="card-title">Netlify Pipeline</div>
            <div class="card-desc">CI/CD · local to production</div>
          </div>
          <div class="card-num">5</div>
        </div>
        <span class="card-badge">Pipeline</span>
      </div>

    </div>

    <div class="sidebar-footer">
      <div class="live-dot" style="width:5px;height:5px;"></div>
      5 diagrams · interactive
    </div>
  </div>

  <!-- CENTER GRAPH -->
  <div id="center">
    <div id="graph-header">
      <svg width="13" height="13" viewBox="0 0 16 16" fill="var(--accent)" style="flex-shrink:0">
        <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
      </svg>
      <span id="graph-title">System Architecture</span>
      <span id="graph-subtitle">— Full stack service graph</span>
      <div id="node-count-badge">7 nodes · 8 edges</div>
    </div>

    <div id="cy-wrap">
      <div id="cy-grid"></div>
      <div id="cy"></div>
      <div id="loading"><div class="spinner"></div></div>
      <div id="legend" id="graph-legend">
        <!-- filled dynamically -->
      </div>
    </div>

    <!-- CONTROLS -->
    <div id="graph-controls">
      <button class="ctrl-btn" id="btn-zoom-out" title="Zoom out (-)">
        <svg width="11" height="11" viewBox="0 0 16 16" fill="currentColor"><path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z"/></svg>
      </button>
      <span id="zoom-label">100%</span>
      <button class="ctrl-btn" id="btn-zoom-in" title="Zoom in (+)">
        <svg width="11" height="11" viewBox="0 0 16 16" fill="currentColor"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
      </button>
      <div class="ctrl-sep"></div>
      <button class="ctrl-btn" id="btn-fit" title="Fit (F)">
        <svg width="11" height="11" viewBox="0 0 16 16" fill="currentColor"><path d="M5.5 0a.5.5 0 0 1 .5.5v4A1.5 1.5 0 0 1 4.5 6h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5zm5 0a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 10 4.5v-4a.5.5 0 0 1 .5-.5zM0 10.5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 6 11.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zm10 1a1.5 1.5 0 0 1 1.5-1.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4z"/></svg>
      </button>
      <button class="ctrl-btn" id="btn-reset" title="Reload layout (R)">
        <svg width="11" height="11" viewBox="0 0 16 16" fill="currentColor"><path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
      </button>
      <button class="ctrl-btn" id="btn-export" title="Export PNG">
        <svg width="11" height="11" viewBox="0 0 16 16" fill="currentColor"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
      </button>
      <div class="ctrl-sep"></div>
      <div id="status-area">
        <span id="layout-tag">dagre</span>
        <span id="status-txt">Ready</span>
      </div>
    </div>
  </div>

  <!-- RIGHT INSPECTOR -->
  <div id="inspector">
    <div class="insp-header">
      <svg width="11" height="11" viewBox="0 0 16 16" fill="currentColor"><path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/><path d="M6.5 3a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1h-3zm-2 2.5A.5.5 0 0 1 5 5h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zm0 3A.5.5 0 0 1 5 8h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zm0 3A.5.5 0 0 1 5 11h4a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5z"/></svg>
      Diagram Inspector
    </div>

    <div class="insp-body">

      <div class="insp-section">
        <div class="insp-section-title">Display Options</div>

        <div class="toggle-row">
          <span class="toggle-label"><span class="lbl-icon">→</span>Show Arrows</span>
          <label class="toggle">
            <input type="checkbox" id="toggle-arrows" checked>
            <div class="toggle-track"></div>
          </label>
        </div>

        <div class="toggle-row">
          <span class="toggle-label"><span class="lbl-icon">T</span>Show Labels</span>
          <label class="toggle">
            <input type="checkbox" id="toggle-labels" checked>
            <div class="toggle-track"></div>
          </label>
        </div>

        <div class="toggle-row">
          <span class="toggle-label"><span class="lbl-icon">⊞</span>Mini Map</span>
          <label class="toggle">
            <input type="checkbox" id="toggle-minimap">
            <div class="toggle-track"></div>
          </label>
        </div>

        <div class="toggle-row">
          <span class="toggle-label"><span class="lbl-icon">⊟</span>Compact View</span>
          <label class="toggle">
            <input type="checkbox" id="toggle-compact">
            <div class="toggle-track"></div>
          </label>
        </div>

        <div class="toggle-row">
          <span class="toggle-label"><span class="lbl-icon">⌁</span>Edge Labels</span>
          <label class="toggle">
            <input type="checkbox" id="toggle-edge-labels">
            <div class="toggle-track"></div>
          </label>
        </div>

        <div class="toggle-row">
          <span class="toggle-label"><span class="lbl-icon">✦</span>Highlights</span>
          <label class="toggle">
            <input type="checkbox" id="toggle-highlights" checked>
            <div class="toggle-track"></div>
          </label>
        </div>
      </div>

      <div class="insp-section">
        <div class="insp-section-title">Generation Settings</div>

        <div class="slider-row">
          <div class="slider-lbl-row">
            <span class="slider-lbl">Complexity</span>
            <span class="slider-val" id="val-complexity">Medium</span>
          </div>
          <input type="range" id="sld-complexity" min="1" max="3" value="2">
        </div>

        <div class="slider-row">
          <div class="slider-lbl-row">
            <span class="slider-lbl">Max Nodes</span>
            <span class="slider-val" id="val-nodes">20</span>
          </div>
          <input type="range" id="sld-nodes" min="5" max="50" value="20">
        </div>

        <div class="slider-row">
          <div class="slider-lbl-row">
            <span class="slider-lbl">Node Spacing</span>
            <span class="slider-val" id="val-spacing">60px</span>
          </div>
          <input type="range" id="sld-spacing" min="30" max="120" value="60">
        </div>
      </div>

      <div class="insp-section">
        <div class="insp-section-title">Selected Node</div>
        <div id="node-inspector">
          <div class="ni-header">
            <div class="ni-dot" id="ni-dot"></div>
            <div class="ni-name" id="ni-name">—</div>
          </div>
          <div class="ni-row">
            <span class="ni-key">Type</span>
            <span class="ni-val" id="ni-type">—</span>
          </div>
          <div class="ni-row">
            <span class="ni-key">Diagram</span>
            <span class="ni-val" id="ni-diagram">—</span>
          </div>
          <div class="ni-row">
            <span class="ni-key">In-degree</span>
            <span class="ni-val" id="ni-in">—</span>
          </div>
          <div class="ni-row">
            <span class="ni-key">Out-degree</span>
            <span class="ni-val" id="ni-out">—</span>
          </div>
          <div class="ni-row">
            <span class="ni-key">Description</span>
            <span class="ni-val" id="ni-desc" style="font-size:10px;color:var(--text2);max-width:120px;text-align:right">—</span>
          </div>
        </div>
      </div>

    </div>

    <div id="graph-stats">
      <div class="stat-box">
        <div class="stat-val" id="stat-nodes">—</div>
        <div class="stat-lbl">Nodes</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="stat-edges">—</div>
        <div class="stat-lbl">Edges</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="stat-density">—</div>
        <div class="stat-lbl">Density</div>
      </div>
      <div class="stat-box">
        <div class="stat-val" id="stat-roots">—</div>
        <div class="stat-lbl">Roots</div>
      </div>
    </div>
  </div>

</div><!-- /app -->

<!-- TOOLTIP -->
<div id="tooltip">
  <strong id="tt-name"></strong>
  <span id="tt-desc"></span>
</div>

<script>
(function() {
'use strict';

// Register dagre layout
if (window.cytoscapeDagre) cytoscape.use(cytoscapeDagre);

// ─── COLORS ──────────────────────────────────────────────────────────────────
const C = {
  purple: '#bc8cff',
  blue:   '#58a6ff',
  green:  '#3fb950',
  orange: '#ffa657',
  teal:   '#56d364',
  yellow: '#e3b341',
  gray:   '#6e7681',
  red:    '#f85149',
  pink:   '#f778ba',
  cyan:   '#39c5cf',
  gold:   '#d29922',
};

// ─── DIAGRAM DATA ─────────────────────────────────────────────────────────────
const DIAGRAMS = {
  system: {
    title: 'System Architecture',
    subtitle: '— Full stack service graph',
    rankDir: 'TB',
    legend: [
      { color: C.purple, label: 'Orchestrator' },
      { color: C.blue,   label: 'Service' },
      { color: C.green,  label: 'Database' },
      { color: C.orange, label: 'External' },
    ],
    nodes: [
      { id: 'claude',      label: 'Claude Code',      type: 'orchestrator', color: C.purple, desc: 'Main AI orchestrator (--dangerously-skip-permissions)' },
      { id: 'opencode',    label: 'opencode',          type: 'orchestrator', color: C.blue,   desc: 'AI coding TUI — daily driver' },
      { id: 'omc',         label: 'oh-my-claudecode',  type: 'service',      color: C.teal,   desc: 'Agent orchestration plugin' },
      { id: 'openclaw',    label: 'OpenClaw',          type: 'service',      color: C.cyan,   desc: 'Gateway AI — WhatsApp + Lena' },
      { id: 'antigravity', label: 'Antigravity',       type: 'external',     color: C.orange, desc: 'Gemini 3 Pro/Flash via proxy' },
      { id: 'rtx5090',     label: 'RTX 5090',          type: 'hardware',     color: C.yellow, desc: 'Local GPU inference' },
      { id: 'supabase',    label: 'Supabase',          type: 'database',     color: C.green,  desc: 'Postgres + pgvector — mémoire AI' },
      { id: 'github',      label: 'GitHub',            type: 'external',     color: C.orange, desc: 'Source control & CI' },
      { id: 'netlify',     label: 'Netlify',           type: 'service',      color: C.teal,   desc: 'Edge CDN deployments' },
      { id: 'dashboard',   label: 'Dashboard',         type: 'ui',           color: C.gray,   desc: 'This interface' },
    ],
    edges: [
      { s: 'claude',      t: 'supabase',    label: 'memory' },
      { s: 'claude',      t: 'github',      label: 'commits' },
      { s: 'claude',      t: 'openclaw',    label: 'bridge' },
      { s: 'claude',      t: 'netlify',     label: 'deploy' },
      { s: 'claude',      t: 'omc',         label: 'plugin' },
      { s: 'opencode',    t: 'supabase',    label: 'sqlite MCP' },
      { s: 'opencode',    t: 'github',      label: 'commits' },
      { s: 'antigravity', t: 'opencode',    label: 'models' },
      { s: 'rtx5090',     t: 'claude',      label: 'local LLM' },
      { s: 'rtx5090',     t: 'opencode',    label: 'inference' },
      { s: 'openclaw',    t: 'supabase',    label: 'sync' },
      { s: 'github',      t: 'netlify',     label: 'CI/CD' },
      { s: 'netlify',     t: 'dashboard',   label: 'serves' },
    ],
  },

  agents: {
    title: 'Agent Routing',
    subtitle: '— Multi-agent orchestration topology',
    rankDir: 'TB',
    legend: [
      { color: C.purple, label: 'Orchestrator' },
      { color: C.gold,   label: 'Advisor' },
      { color: C.blue,   label: 'Worker' },
    ],
    nodes: [
      { id: 'sisyphus',   label: 'Sisyphus',    type: 'orchestrator', color: C.purple, desc: 'Master orchestrator' },
      { id: 'oracle',     label: 'Oracle',      type: 'advisor',      color: C.gold,   desc: 'Read-only expert' },
      { id: 'explore',    label: 'Explore',     type: 'worker',       color: C.blue,   desc: 'AST & codebase scan' },
      { id: 'librarian',  label: 'Librarian',   type: 'worker',       color: C.cyan,   desc: 'External docs lookup' },
      { id: 'metis',      label: 'Metis',       type: 'worker',       color: C.pink,   desc: 'Strategic planning' },
      { id: 'momus',      label: 'Momus',       type: 'worker',       color: C.orange, desc: 'Code criticism' },
      { id: 'prometheus', label: 'Prometheus',  type: 'worker',       color: C.red,    desc: 'Architecture design' },
    ],
    edges: [
      { s: 'sisyphus', t: 'oracle',     label: 'consult' },
      { s: 'sisyphus', t: 'explore',    label: 'dispatch' },
      { s: 'sisyphus', t: 'librarian',  label: 'dispatch' },
      { s: 'sisyphus', t: 'metis',      label: 'dispatch' },
      { s: 'sisyphus', t: 'momus',      label: 'dispatch' },
      { s: 'sisyphus', t: 'prometheus', label: 'dispatch' },
    ],
  },

  memory: {
    title: 'Memory Flow',
    subtitle: '— Context loading & caching pipeline',
    rankDir: 'TB',
    legend: [
      { color: C.purple, label: 'Session' },
      { color: C.blue,   label: 'Loader' },
      { color: C.green,  label: 'Storage' },
    ],
    nodes: [
      { id: 'session',  label: 'Session Start',        type: 'trigger',  color: C.purple, desc: 'New opencode session' },
      { id: 'loader',   label: 'context-loader.mjs',   type: 'service',  color: C.blue,   desc: 'Loads context on start' },
      { id: 'sbrest',   label: 'Supabase REST',         type: 'api',      color: C.green,  desc: 'Fetches memory rows' },
      { id: 'cache',    label: '~/.context-cache.md',   type: 'file',     color: C.gray,   desc: 'Filesystem cache' },
      { id: 'ctx',      label: 'Claude Context',        type: 'output',   color: C.purple, desc: 'Injected into prompt' },
      { id: 'sync',     label: 'OpenClaw Sync',         type: 'service',  color: C.blue,   desc: 'Cross-agent memory' },
    ],
    edges: [
      { s: 'session', t: 'loader',  label: 'triggers' },
      { s: 'loader',  t: 'sbrest',  label: 'fetch' },
      { s: 'loader',  t: 'cache',   label: 'reads' },
      { s: 'sbrest',  t: 'cache',   label: 'writes' },
      { s: 'cache',   t: 'ctx',     label: 'injects' },
      { s: 'ctx',     t: 'sync',    label: 'broadcasts' },
    ],
  },

  mcp: {
    title: 'MCP Inventory',
    subtitle: '— All registered Model Context Protocol servers',
    rankDir: 'TB',
    legend: [
      { color: C.blue,  label: 'Core Host' },
      { color: C.green, label: 'New' },
      { color: C.gray,  label: 'MCP Tool' },
    ],
    nodes: [
      { id: 'opencode',   label: 'opencode',            type: 'hub',  color: C.blue,   desc: 'MCP host runtime' },
      { id: 'filesystem', label: 'filesystem',          type: 'mcp',  color: C.gray,   desc: 'File read/write — /home/fvegiard' },
      { id: 'git',        label: 'git',                 type: 'mcp',  color: C.orange, desc: 'Git — opencode-config repo' },
      { id: 'git_dash',   label: 'git-dashboard',       type: 'mcp',  color: C.orange, desc: 'Git — opencode-dashboard repo' },
      { id: 'sqlite',     label: 'sqlite',              type: 'mcp',  color: C.green,  desc: 'opencode.db — sessions & memory' },
      { id: 'fetch',      label: 'fetch',               type: 'mcp',  color: C.gray,   desc: 'HTTP fetch tool' },
      { id: 'seqthink',   label: 'sequential-thinking', type: 'mcp',  color: C.purple, desc: 'Chain of thought' },
      { id: 'memory',     label: 'memory ✦',            type: 'mcp',  color: C.green,  desc: 'Persistent KV store', glow: true },
      { id: 'devtools',   label: 'devtools ✦',          type: 'mcp',  color: C.teal,   desc: 'Custom: LSP + lint + shell', glow: true },
    ],
    edges: [
      { s: 'opencode', t: 'filesystem' },
      { s: 'opencode', t: 'git' },
      { s: 'opencode', t: 'git_dash' },
      { s: 'opencode', t: 'sqlite' },
      { s: 'opencode', t: 'fetch' },
      { s: 'opencode', t: 'seqthink' },
      { s: 'opencode', t: 'memory' },
      { s: 'opencode', t: 'devtools' },
    ],
  },

  netlify: {
    title: 'Netlify Pipeline',
    subtitle: '— CI/CD deploy flow from local to production',
    rankDir: 'LR',
    legend: [
      { color: C.purple, label: 'Local' },
      { color: C.orange, label: 'SCM' },
      { color: C.teal,   label: 'CI/CD' },
      { color: C.green,  label: 'Live' },
    ],
    nodes: [
      { id: 'local',    label: 'Local Claude',      type: 'origin',  color: C.purple, desc: 'Dev machine + Claude Code' },
      { id: 'repo',     label: 'GitHub Repo',       type: 'scm',     color: C.orange, desc: 'Source of truth' },
      { id: 'ci',       label: 'Netlify CI',        type: 'ci',      color: C.teal,   desc: 'Build & deploy pipeline' },
      { id: 'runner',   label: 'Claude Agent Runner',type: 'service', color: C.blue,   desc: 'AI-powered build agent' },
      { id: 'live',     label: 'Live Site',         type: 'prod',    color: C.green,  desc: 'Production at netlify.app' },
    ],
    edges: [
      { s: 'local',  t: 'repo',   label: 'git push' },
      { s: 'repo',   t: 'ci',     label: 'webhook' },
      { s: 'ci',     t: 'runner', label: 'triggers' },
      { s: 'runner', t: 'live',   label: 'deploys' },
    ],
  },
};

// ─── STATE ────────────────────────────────────────────────────────────────────
let cy = null;
let currentId = 'system';
const tooltip = document.getElementById('tooltip');
let highlightsEnabled = true;

// ─── BUILD CYTOSCAPE ELEMENTS ────────────────────────────────────────────────
function buildElements(data) {
  const nodes = data.nodes.map(n => ({
    data: { id: n.id, label: n.label, type: n.type || 'default', color: n.color || '#6e7681', desc: n.desc || '', glow: n.glow || false }
  }));
  const edges = data.edges.map((e, i) => ({
    data: { id: 'e' + i, source: e.s, target: e.t, label: e.label || '' }
  }));
  return [...nodes, ...edges];
}

// ─── CYTOSCAPE STYLE ─────────────────────────────────────────────────────────
function buildStyle() {
  return [
    {
      selector: 'node',
      style: {
        'background-color': '#161b22',
        'border-color': 'data(color)',
        'border-width': 2,
        'label': 'data(label)',
        'color': '#e6edf3',
        'font-size': 11,
        'font-family': '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
        'text-valign': 'center',
        'text-halign': 'center',
        'shape': 'roundrectangle',
        'width': 'label',
        'height': 34,
        'padding': '10px',
        'text-wrap': 'none',
        'transition-property': 'opacity, border-width, background-color',
        'transition-duration': 200,
      }
    },
    {
      selector: 'node[type = "orchestrator"]',
      style: { 'border-width': 3, 'font-weight': 700 }
    },
    {
      selector: 'node[type = "hub"]',
      style: { 'border-width': 3, 'font-weight': 700, 'font-size': 12 }
    },
    {
      selector: 'node:selected',
      style: {
        'border-color': '#58a6ff',
        'border-width': 3,
        'background-color': '#1c2128',
      }
    },
    {
      selector: '.faded',
      style: { 'opacity': 0.2 }
    },
    {
      selector: '.highlighted',
      style: {
        'border-width': 3,
        'background-color': '#1c2128',
      }
    },
    {
      selector: 'edge',
      style: {
        'line-color': '#30363d',
        'target-arrow-color': '#58a6ff',
        'target-arrow-shape': 'triangle',
        'curve-style': 'bezier',
        'width': 1.5,
        'arrow-scale': 0.8,
        'label': '',
        'font-size': 9,
        'color': '#8b949e',
        'text-background-color': '#0d1117',
        'text-background-opacity': 1,
        'text-background-padding': '2px',
        'text-rotation': 'autorotate',
        'transition-property': 'opacity, line-color, width',
        'transition-duration': 200,
      }
    },
    {
      selector: 'edge:selected',
      style: { 'line-color': '#58a6ff', 'width': 2.5, 'target-arrow-color': '#58a6ff' }
    },
  ];
}

// ─── INIT GRAPH ───────────────────────────────────────────────────────────────
function loadDiagram(id) {
  currentId = id;
  const data = DIAGRAMS[id];
  if (!data) return;

  // Sidebar active
  document.querySelectorAll('.diagram-card').forEach(c => {
    c.classList.toggle('active', c.dataset.id === id);
  });

  // Header
  document.getElementById('graph-title').textContent = data.title;
  document.getElementById('graph-subtitle').textContent = data.subtitle;

  // Show loading
  document.getElementById('loading').classList.add('active');
  document.getElementById('status-txt').textContent = 'Loading…';

  // Node inspector reset
  document.getElementById('node-inspector').classList.remove('visible');

  // Destroy old instance
  if (cy) { cy.destroy(); cy = null; }

  // Wait one tick for paint
  requestAnimationFrame(() => {
    cy = cytoscape({
      container: document.getElementById('cy'),
      elements: buildElements(data),
      style: buildStyle(),
      layout: {
        name: 'dagre',
        rankDir: data.rankDir || 'TB',
        rankSep: 80,
        nodeSep: 50,
        edgeSep: 20,
        padding: 50,
        animate: true,
        animationDuration: 450,
        animationEasing: 'ease-out-cubic',
        fit: true,
      },
      minZoom: 0.15,
      maxZoom: 4,
      wheelSensitivity: 0.25,
    });

    // Per-node border color from data
    cy.nodes().forEach(n => {
      const col = n.data('color');
      if (col) n.style('border-color', col);
      if (n.data('glow')) {
        n.style({
          'border-color': '#3fb950',
          'background-color': 'rgba(63,185,80,0.07)',
        });
      }
    });

    // Zoom tracking
    cy.on('zoom pan', () => {
      document.getElementById('zoom-label').textContent =
        Math.round(cy.zoom() * 100) + '%';
    });

    // Node tap → inspector
    cy.on('tap', 'node', function(e) {
      const n = e.target;
      document.getElementById('ni-dot').style.background = n.data('color') || '#58a6ff';
      document.getElementById('ni-name').textContent = n.data('label');
      document.getElementById('ni-type').textContent = n.data('type') || '—';
      document.getElementById('ni-diagram').textContent = data.title;
      document.getElementById('ni-in').textContent = n.indegree();
      document.getElementById('ni-out').textContent = n.outdegree();
      document.getElementById('ni-desc').textContent = n.data('desc') || '—';
      document.getElementById('node-inspector').classList.add('visible');

      if (highlightsEnabled) {
        cy.elements().removeClass('faded highlighted');
        const conn = n.closedNeighborhood();
        cy.elements().not(conn).addClass('faded');
        conn.addClass('highlighted');
      }
    });

    // Background tap → deselect
    cy.on('tap', function(e) {
      if (e.target === cy) {
        cy.elements().removeClass('faded highlighted');
        document.getElementById('node-inspector').classList.remove('visible');
      }
    });

    // Tooltip on hover
    cy.on('mouseover', 'node', function(e) {
      const n = e.target;
      if (!n.data('desc')) return;
      const cyEl = document.getElementById('cy');
      const rect = cyEl.getBoundingClientRect();
      const rp = e.renderedPosition;
      document.getElementById('tt-name').textContent = n.data('label');
      document.getElementById('tt-desc').textContent = n.data('desc');
      tooltip.style.left = (rect.left + rp.x + 16) + 'px';
      tooltip.style.top  = (rect.top  + rp.y - 12) + 'px';
      tooltip.style.display = 'block';
    });

    cy.on('mouseout drag', 'node', () => {
      tooltip.style.display = 'none';
    });

    // After layout
    cy.on('layoutstop', () => {
      document.getElementById('loading').classList.remove('active');
      document.getElementById('status-txt').textContent = 'Ready';
      updateStats();
      applyToggles();
      updateLegend(data);
    });

    // Fallback hide loading
    setTimeout(() => {
      document.getElementById('loading').classList.remove('active');
      document.getElementById('status-txt').textContent = 'Ready';
      updateStats();
    }, 1200);
  });
}

// ─── LEGEND ──────────────────────────────────────────────────────────────────
function updateLegend(data) {
  const el = document.getElementById('legend');
  if (!el || !data.legend) return;
  el.innerHTML = data.legend.map(l =>
    `<div class="legend-item">
       <div class="legend-dot" style="background:${l.color}"></div>
       ${l.label}
     </div>`
  ).join('');
}

// ─── STATS ───────────────────────────────────────────────────────────────────
function updateStats() {
  if (!cy) return;
  const n = cy.nodes().length;
  const e = cy.edges().length;
  const roots = cy.nodes().filter(nd => nd.indegree() === 0).length;
  const maxE = n * (n - 1);
  const density = maxE > 0 ? (e / maxE).toFixed(2) : '—';

  document.getElementById('stat-nodes').textContent = n;
  document.getElementById('stat-edges').textContent = e;
  document.getElementById('stat-density').textContent = density;
  document.getElementById('stat-roots').textContent = roots;
  document.getElementById('node-count-badge').textContent = `${n} nodes · ${e} edges`;
}

// ─── TOGGLES ──────────────────────────────────────────────────────────────────
function applyToggles() {
  if (!cy) return;
  const arrows = document.getElementById('toggle-arrows').checked;
  const labels = document.getElementById('toggle-labels').checked;
  const edgeL  = document.getElementById('toggle-edge-labels').checked;

  cy.edges().style('target-arrow-shape', arrows ? 'triangle' : 'none');
  cy.nodes().style('label', labels ? 'data(label)' : '');
  cy.edges().style('label', edgeL ? 'data(label)' : '');
}

document.getElementById('toggle-arrows').addEventListener('change', (e) => {
  if (!cy) return;
  cy.edges().style('target-arrow-shape', e.target.checked ? 'triangle' : 'none');
});

document.getElementById('toggle-labels').addEventListener('change', (e) => {
  if (!cy) return;
  cy.nodes().style('label', e.target.checked ? 'data(label)' : '');
});

document.getElementById('toggle-minimap').addEventListener('change', (e) => {
  // Visual stub — real minimap requires cytoscape-navigator
  document.getElementById('status-txt').textContent =
    e.target.checked ? 'Mini map (β)' : 'Ready';
});

document.getElementById('toggle-compact').addEventListener('change', (e) => {
  if (!cy) return;
  cy.fit(undefined, e.target.checked ? 15 : 50);
  document.getElementById('zoom-label').textContent = Math.round(cy.zoom() * 100) + '%';
});

document.getElementById('toggle-edge-labels').addEventListener('change', (e) => {
  if (!cy) return;
  cy.edges().style('label', e.target.checked ? 'data(label)' : '');
});

document.getElementById('toggle-highlights').addEventListener('change', (e) => {
  highlightsEnabled = e.target.checked;
  if (!e.target.checked && cy) cy.elements().removeClass('faded highlighted');
});

// ─── SLIDERS ─────────────────────────────────────────────────────────────────
const COMPLEXITY_LABELS = { '1': 'Low', '2': 'Medium', '3': 'High' };
document.getElementById('sld-complexity').addEventListener('input', (e) => {
  document.getElementById('val-complexity').textContent = COMPLEXITY_LABELS[e.target.value] || 'Medium';
});

document.getElementById('sld-nodes').addEventListener('input', (e) => {
  document.getElementById('val-nodes').textContent = e.target.value;
});

document.getElementById('sld-spacing').addEventListener('input', (e) => {
  document.getElementById('val-spacing').textContent = e.target.value + 'px';
});

// ─── CONTROL BUTTONS ─────────────────────────────────────────────────────────
document.getElementById('btn-zoom-in').addEventListener('click', () => {
  if (!cy) return;
  cy.zoom({ level: cy.zoom() * 1.25, renderedPosition: { x: cy.width() / 2, y: cy.height() / 2 } });
});

document.getElementById('btn-zoom-out').addEventListener('click', () => {
  if (!cy) return;
  cy.zoom({ level: cy.zoom() * 0.8, renderedPosition: { x: cy.width() / 2, y: cy.height() / 2 } });
});

document.getElementById('btn-fit').addEventListener('click', () => {
  if (!cy) return;
  cy.fit(undefined, 40);
  document.getElementById('zoom-label').textContent = Math.round(cy.zoom() * 100) + '%';
});

document.getElementById('btn-reset').addEventListener('click', () => {
  loadDiagram(currentId);
});

document.getElementById('btn-export').addEventListener('click', () => {
  if (!cy) return;
  try {
    const png = cy.png({ full: true, scale: 2, bg: '#0d1117' });
    const a = document.createElement('a');
    a.href = png;
    a.download = `${currentId}-diagram.png`;
    a.click();
    document.getElementById('status-txt').textContent = 'Exported!';
    setTimeout(() => { document.getElementById('status-txt').textContent = 'Ready'; }, 2000);
  } catch(err) {
    document.getElementById('status-txt').textContent = 'Export failed';
  }
});

// ─── KEYBOARD ────────────────────────────────────────────────────────────────
document.addEventListener('keydown', (e) => {
  if (e.target.tagName === 'INPUT') return;
  if (e.key === '+' || e.key === '=') document.getElementById('btn-zoom-in').click();
  if (e.key === '-') document.getElementById('btn-zoom-out').click();
  if (e.key === 'f' || e.key === 'F') document.getElementById('btn-fit').click();
  if (e.key === 'r' || e.key === 'R') document.getElementById('btn-reset').click();
  const ids = ['system', 'agents', 'memory', 'mcp', 'netlify'];
  const n = parseInt(e.key);
  if (n >= 1 && n <= 5) loadDiagram(ids[n - 1]);
});

// ─── SUPABASE COUNT ──────────────────────────────────────────────────────────
async function fetchCount() {
  try {
    const r = await fetch(
      'https://iawsshgkogntmdzrfjyw.supabase.co/rest/v1/memory?select=count',
      {
        headers: {
          'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlhd3NzaGdrb2dudG1kenJmanl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2NDkwMDUsImV4cCI6MjA4MzIyNTAwNX0.1BxhI5SWLL5786qsshidOMpTsOrGeNob6xpcKQjI4s4',
          'Prefer': 'count=exact',
        }
      }
    );
    // Try content-range header first
    const cr = r.headers.get('content-range') || r.headers.get('Content-Range');
    if (cr) {
      const m = cr.match(/\/(\d+)/);
      if (m) { document.getElementById('supabase-count').textContent = parseInt(m[1]).toLocaleString(); return; }
    }
    const data = await r.json();
    if (Array.isArray(data)) document.getElementById('supabase-count').textContent = data.length;
    else if (data && data[0] && data[0].count !== undefined) document.getElementById('supabase-count').textContent = data[0].count;
  } catch(_) {
    document.getElementById('supabase-count').textContent = '—';
  }
}

// ─── BOOT ─────────────────────────────────────────────────────────────────────
fetchCount();
setInterval(fetchCount, 60000);
loadDiagram('system');

})();
</script>
</body>
</html>
